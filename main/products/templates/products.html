{% extends 'base.html' %}

{% block encabezado %}
<h1>Catálogo de Productos Herbalife</h1>
{% endblock %}

{% block contenido %}
    <div class="products-page">
        <div class="products-header">
            <div class="page-heading">
                <h1>Catálogo de Productos Herbalife</h1>
            </div>
            <form method="get" action="{% url 'list_products' %}" class="search-form" role="search" aria-label="Buscar productos">
                <input
                    type="text"
                    name="q"
                    class="search-input"
                    placeholder="Buscar productos por nombre..."
                    value="{{ q|default:'' }}"
                />
                <button type="submit" class="search-btn" aria-label="Buscar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
                <a href="{% url 'list_products' %}" class="clear-btn" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">×</a>
            </form>
        </div>

        <div class="products-grid">
        {% for product in products %}
            <article id="product-{{ product.id }}" class="product-card">
                {% if product.image %}
                    {% if product.image|slice:":4" == "http" %}
                        <img class="product-image" src="{{ product.image }}" alt="{{ product.name }}">
                    {% else %}
                        <img class="product-image" src="{{ product.image.url }}" alt="{{ product.name }}">
                    {% endif %}
                {% else %}
                    <div class="no-image">No hay imagen disponible.</div>
                {% endif %}

                <div class="product-info">
                    <div class="product-title">{{ product.name }}</div>
                    {% if product.flavor %}
                        <div class="product-meta"> <b>・ Sabor:</b> {{ product.flavor }} </div>
                    {% else %}
                        <div class="product-meta"> <b>・ Sabor:</b> Sin sabor</div>
                    {% endif %}
                    
                    {% if product.size %}
                        <div class="product-meta"> <b>・ Tamaño:</b> {{ product.size }} </div>
                    {% else %}
                        <div class="product-meta"></div>
                    {% endif %}

                    <div class="price-row">
                        <div class="price">{{ product.price }} €</div>
                        <div class="stock">Stock Disponible: {{ product.available_stock }}</div>
                    </div>

                    <form action="{% url 'add_to_cart' product_id=product.id %}" method="post" class="add-to-cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="page" value="{{ products.number }}">
                        <input type="hidden" name="q" value="{{ q|default:'' }}">
                        <div class="add-to-cart-row">
                            {% comment %} Usar atributos preparados en la vista: product.in_cart_qty y product.max_add {% endcomment %}
                            <div class="quantity-control" data-product-id="{{ product.id }}" data-stock="{{ product.stock }}" data-in-cart="{{ product.in_cart_qty|default:0 }}">
                                <button type="button" class="decr-btn">−</button>
                                <input type="number" name="quantity" class="quantity-input" value="1" min="1" max="{{ product.max_add|default:0 }}" readonly>
                                <button type="button" class="incr-btn">+</button>
                            </div>
                            <button type="submit" class="add-to-cart-button">Añadir al Carrito</button>
                        </div>
                    </form>

                </div>
            </article>
        {% empty %}
            <p class="no-products">No hay productos disponibles en este momento.</p>
        {% endfor %}
        </div>

        <div class="pagination">
        {% if products.has_previous %}
            <a href="?page={{ products.previous_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn-page">Anterior</a>
        {% else %}
            <button class="btn-page disabled" disabled>Anterior</button>
        {% endif %}

        {% if products.has_next %}
            <a href="?page={{ products.next_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn-page">Siguiente</a>
        {% else %}
            <button class="btn-page disabled" disabled>Siguiente</button>
        {% endif %}
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.quantity-control').forEach(function(ctrl){
            var prodId = ctrl.getAttribute('data-product-id');
            var stock = parseInt(ctrl.getAttribute('data-stock') || '0', 10);
            var inCart = parseInt(ctrl.getAttribute('data-in-cart') || '0', 10);
            var input = ctrl.querySelector('.quantity-input');
            var decr = ctrl.querySelector('.decr-btn');
            var incr = ctrl.querySelector('.incr-btn');
            var maxAllowed = parseInt(input.getAttribute('max') || '0', 10);

            function updateButtons(){
                var val = parseInt(input.value || '0', 10);
                if (isNaN(val) || val < 1) val = 1;
                if (val > maxAllowed) val = maxAllowed;
                input.value = val;
                if (val <= 1) decr.disabled = true; else decr.disabled = false;
                if (val >= maxAllowed) incr.disabled = true; else incr.disabled = false;
                if (maxAllowed <= 0){
                    input.disabled = true;
                    decr.disabled = true;
                    incr.disabled = true;
                    var form = ctrl.closest('form');
                    if (form){
                        var submit = form.querySelector('button[type=submit]');
                        if (submit) submit.disabled = true;
                    }
                }
            }

            decr.addEventListener('click', function(){
                var val = parseInt(input.value || '0', 10) - 1;
                if (isNaN(val)) val = 1;
                if (val < 1) val = 1;
                input.value = val;
                updateButtons();
            });

            incr.addEventListener('click', function(){
                var val = parseInt(input.value || '0', 10) + 1;
                if (isNaN(val)) val = 1;
                if (val > maxAllowed) val = maxAllowed;
                input.value = val;
                updateButtons();
            });

            input.addEventListener('change', updateButtons);
            updateButtons();
        });
    });
    </script>

{% endblock %}